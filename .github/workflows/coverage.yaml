---
name: Coverage

"on": push

jobs:
  test-coverage:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install kcov Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y binutils-dev build-essential cmake git \
          libssl-dev libcurl4-openssl-dev libelf-dev libdw-dev \
          libiberty-dev zlib1g-dev libstdc++-12-dev

      - name: Build and Install kcov
        run: |
          git clone https://github.com/SimonKagstrom/kcov.git
          cd kcov
          mkdir build && cd build
          cmake ..
          make -j$(nproc)
          sudo make install

      # --- SUITE 1: INSTALLER ---
      - name: "Test Suite: Installer"
        run: |
          export PS4='+ '

          # FIX: Manually create the output directory first
          mkdir -p coverage/installer

          # FIX: Ensure the test script is executable
          chmod +x ./tests/test-install-logic.sh

          kcov --bash-handle-sh-invocation \
               --include-pattern=install.sh \
               --exclude-path=.git,tests \
               coverage/installer \
               ./tests/test-install-logic.sh

      # --- SUITE 2: CORE APPLICATION (Placeholder) ---
      - name: "Test Suite: Core System"
        run: |
          export PS4='+ '

          # FIX: Create the placeholder directory so Upload step doesn't fail
          mkdir -p coverage/core

          # (Uncomment when you have the system test ready)
          # chmod +x ./tests/test-system.sh
          # kcov ... coverage/core ./tests/test-system.sh

      # --- GENERATE CONFIG ---
      - name: Create Codecov Config
        run: |
          cat <<EOF > codecov.yml
          coverage:
            status:
              project:
                default:
                  target: auto
                  threshold: 1%
              # You can even enforce different rules for core vs installer!
              patch:
                default:
                  target: 100%
                  threshold: 0%
          flag_management:
            default_rules:
              carryforward: true
          EOF

      # --- UPLOAD ---
      # We upload the parent 'coverage' folder.
      # Codecov recursively finds all reports inside (installer/ and core/).
      - name: Upload to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          directory: ./coverage
          fail_ci_if_error: true
          verbose: true
